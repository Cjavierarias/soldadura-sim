<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador de Soldadura AR</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 10, 20, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    #loadStatus {
      margin-top: 20px;
      color: #0af;
      font-size: 18px;
      text-align: center;
      max-width: 80%;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(0, 170, 255, 0.3);
      border-radius: 50%;
      border-top-color: #0af;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .start-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 22px;
      font-weight: bold;
      background: linear-gradient(135deg, #0a6, #0fc);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 0 30px rgba(0, 255, 200, 0.6);
      transition: all 0.3s;
      letter-spacing: 1px;
    }

    .start-button:hover {
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 0 0 40px rgba(0, 255, 200, 0.9);
    }

    #app {
      width: 100%;
      height: 100vh;
      position: relative;
      display: none;
    }

    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    canvas {
      z-index: 2;
    }

    /* Panel de controles */
    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 200, 255, 0.3);
    }

    .control-group {
      flex: 1;
      min-width: 150px;
    }

    .control-title {
      font-size: 14px;
      color: #8cf;
      margin-bottom: 5px;
    }

    select, button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 20, 40, 0.8);
      color: white;
      font-size: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }

    select:hover, button:hover {
      background: rgba(0, 40, 80, 0.9);
      border-color: rgba(0, 200, 255, 0.5);
    }

    button.active {
      background: linear-gradient(135deg, #0a6, #0fc);
      border-color: rgba(0, 255, 200, 0.5);
    }

    /* Panel de informaci√≥n */
    #info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 15px;
      z-index: 3;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 0, 0.3);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .info-card {
      background: rgba(0, 20, 40, 0.6);
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #0af;
    }

    .info-title {
      font-size: 14px;
      color: #8cf;
      margin-bottom: 8px;
    }

    .info-value {
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 10px rgba(0, 200, 255, 0.5);
    }

    .info-status {
      color: #ff0;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      grid-column: 1 / -1;
    }

    .good { color: #0f0 !important; }
    .warning { color: #ff0 !important; }
    .error { color: #f00 !important; }

    /* Indicador de √°ngulo */
    #angleIndicator {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      width: 120px;
      height: 120px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .angle-value {
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 10px rgba(0, 200, 255, 0.7);
    }

    /* Botones de acci√≥n */
    #actionButtons {
      position: absolute;
      bottom: 120px;
      left: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .action-btn {
      flex: 1;
      padding: 15px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #0a6, #0fc);
    }

    .action-btn.secondary {
      background: linear-gradient(135deg, #444, #666);
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Media queries para m√≥viles */
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        gap: 5px;
      }
      
      #info {
        grid-template-columns: 1fr 1fr;
        bottom: 100px;
      }
      
      #actionButtons {
        flex-direction: column;
        bottom: 20px;
      }
      
      #angleIndicator {
        width: 80px;
        height: 80px;
        top: 30%;
      }
      
      .angle-value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <p id="loadStatus">Cargando simulador de soldadura...</p>
  </div>
  
  <button id="startBtn" class="start-button">
    üî• INICIAR SIMULADOR DE SOLDADURA
  </button>
  
  <div id="app">
    <video id="camera" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
    
    <!-- Panel de controles -->
    <div id="controls">
      <div class="control-group">
        <div class="control-title">Tipo de Soldadura</div>
        <select id="weldType">
          <option value="mig">MIG/MAG</option>
          <option value="tig">TIG</option>
          <option value="electrodo">Electrodo</option>
        </select>
      </div>
      
      <div class="control-group">
        <div class="control-title">Material Base</div>
        <select id="material">
          <option value="acero">Acero al carbono</option>
          <option value="inox">Acero inoxidable</option>
          <option value="aluminio">Aluminio</option>
        </select>
      </div>
      
      <div class="control-group">
        <div class="control-title">Modo de Entrenamiento</div>
        <button id="modeBtn" class="active">Modo Guiado</button>
      </div>
    </div>
    
    <!-- Indicador de √°ngulo -->
    <div id="angleIndicator">
      <div class="angle-value" id="angleDisplay">--¬∞</div>
    </div>
    
    <!-- Panel de informaci√≥n -->
    <div id="info">
      <div class="info-card">
        <div class="control-title">Distancia</div>
        <div class="info-value" id="dist">-- cm</div>
      </div>
      <div class="info-card">
        <div class="control-title">√Ångulo</div>
        <div class="info-value" id="angle">--¬∞</div>
      </div>
      <div class="info-card">
        <div class="control-title">Velocidad</div>
        <div class="info-value" id="speed">-- cm/s</div>
      </div>
      <div class="info-card">
        <div class="control-title">Estabilidad</div>
        <div class="info-value" id="stability">--%</div>
      </div>
      <div class="info-status" id="markerStatus">
        üîç Buscando marcador de soldadura...
      </div>
    </div>
    
    <!-- Botones de acci√≥n -->
    <div id="actionButtons">
      <button class="action-btn primary" id="calibrateBtn">
        üìê Calibrar √Ångulo Cero
      </button>
      <button class="action-btn secondary" id="helpBtn">
        ‚ùì Ayuda
      </button>
    </div>
    
    <!-- Elementos de audio para feedback -->
    <audio id="goodSound" preload="auto">
      <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="warningSound" preload="auto">
      <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-1551.mp3" type="audio/mpeg">
    </audio>
    <audio id="errorSound" preload="auto">
      <source src="https://assets.mixkit.co/sfx/preview/mixkit-retro-game-emergency-alarm-1000.mp3" type="audio/mpeg">
    </audio>
  </div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/3.4.0/opencv.js" onload="onOpenCvReady()"></script>
  
  <script>
    console.log("üî• Simulador de Soldadura AR - Iniciando...");

    // Variables globales
    let video = null;
    let canvas = null;
    let ctx = null;
    let cvReady = false;
    let isProcessing = false;
    let zeroAngleCalibrated = false;
    let calibrationValue = 0;

    // Configuraci√≥n de soldadura
    let weldConfig = {
      type: 'mig',
      material: 'acero',
      mode: 'guided',
      optimalAngle: {
        mig: { min: 15, max: 25 },
        tig: { min: 10, max: 20 },
        electrodo: { min: 5, max: 15 }
      },
      soundEnabled: true
    };

    // Variables de seguimiento
    let prevTime = 0;
    let prevPos = null;
    let angleHistory = [];
    let stabilityScore = 0;

    // Elementos DOM
    let startBtn = null;
    let appContainer = null;
    let loading = null;
    let loadStatus = null;
    let angleDisplay = null;
    let markerStatusEl = null;

    // Sensores del dispositivo
    let isDeviceOrientationSupported = false;
    let deviceAngle = 0;
    let lastSoundTime = 0;
    const SOUND_COOLDOWN = 500; // ms entre sonidos

    // Inicializaci√≥n cuando el DOM est√° listo
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM cargado");
      
      // Obtener referencias a elementos DOM
      startBtn = document.getElementById('startBtn');
      appContainer = document.getElementById('app');
      loading = document.getElementById('loading');
      loadStatus = document.getElementById('loadStatus');
      video = document.getElementById('camera');
      canvas = document.getElementById('overlay');
      angleDisplay = document.getElementById('angleDisplay');
      markerStatusEl = document.getElementById('markerStatus');
      
      // Contexto del canvas
      ctx = canvas.getContext('2d');
      
      // Configurar botones y controles
      startBtn.addEventListener('click', startApp);
      document.getElementById('weldType').addEventListener('change', updateWeldConfig);
      document.getElementById('material').addEventListener('change', updateWeldConfig);
      document.getElementById('modeBtn').addEventListener('click', toggleMode);
      document.getElementById('calibrateBtn').addEventListener('click', calibrateZeroAngle);
      document.getElementById('helpBtn').addEventListener('click', showHelp);
      
      // Verificar sensores del dispositivo
      checkDeviceSensors();
      
      // Verificar si OpenCV ya est√° cargado
      if (typeof cv !== 'undefined') {
        onOpenCvReady();
      }
    });

    // Verificar sensores del dispositivo
    function checkDeviceSensors() {
      if (window.DeviceOrientationEvent) {
        isDeviceOrientationSupported = true;
        window.addEventListener('deviceorientation', handleDeviceOrientation);
        console.log("‚úÖ Sensores de orientaci√≥n soportados");
      } else {
        console.log("‚ö†Ô∏è Sensores de orientaci√≥n no soportados");
        markerStatusEl.textContent = "‚ö†Ô∏è Usando detecci√≥n por c√°mara (activa los sensores para mejor precisi√≥n)";
      }
    }

    // Manejar orientaci√≥n del dispositivo
    function handleDeviceOrientation(event) {
      // Usar gamma (inclinaci√≥n lateral) para el √°ngulo de soldadura
      if (event.gamma !== null) {
        deviceAngle = event.gamma; // -90 a 90 grados
        
        // Ajustar seg√∫n calibraci√≥n
        let adjustedAngle = deviceAngle - calibrationValue;
        
        // Normalizar a 0-90 grados
        adjustedAngle = Math.abs(adjustedAngle);
        
        // Actualizar display
        angleDisplay.textContent = Math.round(adjustedAngle) + '¬∞';
        
        // Verificar √°ngulo √≥ptimo
        checkOptimalAngle(adjustedAngle);
      }
    }

    // Verificar si el √°ngulo est√° en rango √≥ptimo
    function checkOptimalAngle(angle) {
      if (!weldConfig.soundEnabled || Date.now() - lastSoundTime < SOUND_COOLDOWN) {
        return;
      }
      
      const optimal = weldConfig.optimalAngle[weldConfig.type];
      const angleEl = document.getElementById('angle');
      
      if (angle < optimal.min) {
        // √Ångulo demasiado bajo - sonido agudo
        playSound('errorSound');
        angleEl.className = 'info-value error';
        markerStatusEl.innerHTML = '‚ö†Ô∏è √Ångulo demasiado bajo';
        lastSoundTime = Date.now();
      } else if (angle > optimal.max) {
        // √Ångulo demasiado alto - sonido grave
        playSound('warningSound');
        angleEl.className = 'info-value warning';
        markerStatusEl.innerHTML = '‚ö†Ô∏è √Ångulo demasiado alto';
        lastSoundTime = Date.now();
      } else {
        // √Ångulo √≥ptimo
        angleEl.className = 'info-value good';
        markerStatusEl.innerHTML = '‚úÖ √Ångulo √≥ptimo para soldadura';
      }
    }

    // Reproducir sonido
    function playSound(soundId) {
      if (!weldConfig.soundEnabled) return;
      
      const sound = document.getElementById(soundId);
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
      }
    }

    // Calibrar √°ngulo cero
    function calibrateZeroAngle() {
      calibrationValue = deviceAngle;
      zeroAngleCalibrated = true;
      
      // Feedback visual
      const btn = document.getElementById('calibrateBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úÖ Calibrado!';
      btn.style.background = 'linear-gradient(135deg, #0a6, #0fc)';
      
      playSound('goodSound');
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
      }, 2000);
      
      markerStatusEl.innerHTML = '‚úÖ √Ångulo cero calibrado correctamente';
    }

    // Actualizar configuraci√≥n
    function updateWeldConfig() {
      weldConfig.type = document.getElementById('weldType').value;
      weldConfig.material = document.getElementById('material').value;
      
      // Actualizar display de √°ngulo √≥ptimo
      const optimal = weldConfig.optimalAngle[weldConfig.type];
      markerStatusEl.innerHTML = `üéØ √Ångulo √≥ptimo: ${optimal.min}¬∞ - ${optimal.max}¬∞`;
    }

    // Alternar modo
    function toggleMode() {
      const btn = document.getElementById('modeBtn');
      if (weldConfig.mode === 'guided') {
        weldConfig.mode = 'free';
        btn.innerHTML = 'Modo Libre';
        btn.classList.remove('active');
        markerStatusEl.innerHTML = 'üîì Modo libre activado';
      } else {
        weldConfig.mode = 'guided';
        btn.innerHTML = 'Modo Guiado';
        btn.classList.add('active');
        markerStatusEl.innerHTML = 'üîí Modo guiado activado';
      }
    }

    // Mostrar ayuda
    function showHelp() {
      alert("SIMULADOR DE SOLDADURA\n\n" +
            "1. Coloca el marcador en la superficie a soldar\n" +
            "2. Sost√©n el celular como si fuera una antorcha\n" +
            "3. Calibra el √°ngulo cero presionando el bot√≥n de calibraci√≥n\n" +
            "4. Mant√©n el √°ngulo entre 15¬∞-25¬∞ para soldadura MIG\n" +
            "5. Escucha los sonidos de feedback para corregir el √°ngulo\n\n" +
            "√Ångulos √≥ptimos:\n" +
            "- MIG/MAG: 15¬∞-25¬∞\n" +
            "- TIG: 10¬∞-20¬∞\n" +
            "- Electrodo: 5¬∞-15¬∞");
    }

    // Callback cuando OpenCV.js se carga
    function onOpenCvReady() {
      console.log("‚úÖ OpenCV.js listo!");
      cvReady = true;
      loadStatus.textContent = "OpenCV cargado correctamente";
      loading.style.display = 'none';
      startBtn.style.display = 'block';
    }

    // Iniciar la aplicaci√≥n
    async function startApp() {
      console.log("Iniciando aplicaci√≥n...");
      
      try {
        startBtn.style.display = 'none';
        loadStatus.textContent = "Solicitando acceso a c√°mara y sensores...";
        loading.style.display = 'flex';
        
        // Solicitar acceso a c√°mara
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          }
        });
        
        video.srcObject = stream;
        
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            resolve();
          };
        });
        
        await new Promise((resolve) => {
          video.onplaying = () => {
            console.log("Video reproduci√©ndose");
            resolve();
          };
        });
        
        // Mostrar aplicaci√≥n
        loading.style.display = 'none';
        appContainer.style.display = 'block';
        
        // Iniciar procesamiento
        isProcessing = true;
        processFrame();
        
        // Configurar inicial
        updateWeldConfig();
        
      } catch (error) {
        console.error("‚ùå Error:", error);
        loadStatus.textContent = `Error: ${error.message}`;
        startBtn.style.display = 'block';
        startBtn.textContent = "üîÑ Reintentar";
        
        if (error.name === 'NotAllowedError') {
          alert("Permiso de c√°mara denegado. Por favor, permite el acceso a la c√°mara.");
        }
      }
    }

    // Procesar cada frame
    function processFrame() {
      if (!isProcessing) return;
      
      try {
        // Dibujar video en canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Si OpenCV est√° listo, procesar marcador
        if (cvReady && cv.Mat) {
          processWithOpenCV();
        }
        
        // Dibujar gu√≠as visuales
        drawVisualGuides();
        
        // Actualizar estabilidad
        updateStability();
        
        // Continuar procesamiento
        requestAnimationFrame(processFrame);
        
      } catch (error) {
        console.error("Error en processFrame:", error);
        markerStatusEl.innerHTML = "üî¥ Error de procesamiento";
        isProcessing = false;
      }
    }

    // Procesar con OpenCV
    function processWithOpenCV() {
      // Esta funci√≥n procesar√≠a el marcador ARUCO
      // Por ahora, mostramos informaci√≥n simulada cuando no hay sensores
      if (!isDeviceOrientationSupported) {
        // Simular datos para demostraci√≥n
        const simulatedAngle = 20 + Math.random() * 10;
        angleDisplay.textContent = Math.round(simulatedAngle) + '¬∞';
        checkOptimalAngle(simulatedAngle);
        
        // Actualizar otros valores
        document.getElementById('dist').textContent = (30 + Math.random() * 10).toFixed(1) + ' cm';
        document.getElementById('speed').textContent = (5 + Math.random() * 3).toFixed(1) + ' cm/s';
      }
    }

    // Dibujar gu√≠as visuales
    function drawVisualGuides() {
      // Dibujar ret√≠cula central
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      
      ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(centerX - 50, centerY);
      ctx.lineTo(centerX + 50, centerY);
      ctx.moveTo(centerX, centerY - 50);
      ctx.lineTo(centerX, centerY + 50);
      ctx.stroke();
      
      // Dibujar c√≠rculo de objetivo
      ctx.beginPath();
      ctx.arc(centerX, centerY, 80, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba(0, 200, 255, 0.3)';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // Dibujar indicador de √°ngulo actual
      if (zeroAngleCalibrated) {
        const currentAngle = parseFloat(angleDisplay.textContent) || 0;
        const optimal = weldConfig.optimalAngle[weldConfig.type];
        
        // Dibujar arco de √°ngulo
        ctx.beginPath();
        ctx.arc(centerX, centerY, 100, 
                (optimal.min - 90) * Math.PI / 180, 
                (optimal.max - 90) * Math.PI / 180);
        ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
        ctx.lineWidth = 4;
        ctx.stroke();
        
        // Dibujar l√≠nea de √°ngulo actual
        const angleRad = (currentAngle - 90) * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(
          centerX + Math.cos(angleRad) * 120,
          centerY + Math.sin(angleRad) * 120
        );
        ctx.strokeStyle = currentAngle >= optimal.min && currentAngle <= optimal.max 
          ? '#0f0' : '#f00';
        ctx.lineWidth = 3;
        ctx.stroke();
      }
    }

    // Actualizar puntuaci√≥n de estabilidad
    function updateStability() {
      const currentAngle = parseFloat(angleDisplay.textContent);
      if (!isNaN(currentAngle)) {
        angleHistory.push(currentAngle);
        if (angleHistory.length > 20) angleHistory.shift();
        
        // Calcular variaci√≥n
        if (angleHistory.length > 5) {
          const avg = angleHistory.reduce((a, b) => a + b) / angleHistory.length;
          const variance = angleHistory.reduce((a, b) => a + Math.abs(b - avg), 0) / angleHistory.length;
          stabilityScore = Math.max(0, 100 - variance * 5);
          
          document.getElementById('stability').textContent = Math.round(stabilityScore) + '%';
          document.getElementById('stability').className = stabilityScore > 80 
            ? 'info-value good' 
            : stabilityScore > 60 
              ? 'info-value warning' 
              : 'info-value error';
        }
      }
    }

    // Manejar errores globales
    window.addEventListener('error', function(e) {
      console.error('Error global:', e.error);
      markerStatusEl.innerHTML = "üî¥ Error cr√≠tico - Recarga la p√°gina";
      isProcessing = false;
    });

    // Pausar cuando la p√°gina no es visible
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        isProcessing = false;
      } else if (cvReady && video.srcObject) {
        isProcessing = true;
        processFrame();
      }
    });

    // Vibrar dispositivo (si est√° soportado)
    function vibrateDevice(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }
  </script>
</body>
</html>
